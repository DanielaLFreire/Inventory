# ui/sidebar.py - VERS√ÉO MELHORADA COM CORRE√á√ÉO DE PERSIST√äNCIA
'''
Interface da barra lateral para upload de arquivos - Vers√£o melhorada com status das etapas
NOVO: Corre√ß√£o para persistir arquivos opcionais no session_state
'''

import streamlit as st


def criar_sidebar():
    '''
    Cria a interface da barra lateral com uploads e status das etapas
    CORRE√á√ÉO: Agora persiste arquivos opcionais no session_state de forma segura

    Returns:
        dict: Dicion√°rio com os arquivos carregados
    '''
    st.sidebar.header("üìÅ Upload de Dados")

    # Upload do arquivo de invent√°rio
    arquivo_inventario = st.sidebar.file_uploader(
        "üìã Arquivo de Invent√°rio",
        type=['csv', 'xlsx', 'xls'],
        help="Dados de parcelas (D_cm, H_m, talhao, parcela, cod, idade_anos)"
    )

    # Upload do arquivo de cubagem
    arquivo_cubagem = st.sidebar.file_uploader(
        "üìè Arquivo de Cubagem",
        type=['csv', 'xlsx', 'xls'],
        help="Medi√ß√µes detalhadas (arv, talhao, d_cm, h_m, D_cm, H_m)"
    )

    # CORRE√á√ÉO: Upload opcional de shapefile para √°reas COM PERSIST√äNCIA
    arquivo_shapefile = st.sidebar.file_uploader(
        "üó∫Ô∏è Shapefile √Åreas (Opcional)",
        type=['shp', 'zip'],
        help="Arquivo shapefile com √°reas dos talh√µes",
        key="upload_shapefile_persistente"
    )

    # CORRE√á√ÉO: Armazenar shapefile no session_state de forma segura
    try:
        if arquivo_shapefile is not None:
            st.session_state.arquivo_shapefile = arquivo_shapefile
            st.sidebar.success(f"‚úÖ Shapefile salvo: {arquivo_shapefile.name}")
        elif not hasattr(st.session_state, 'arquivo_shapefile'):
            st.session_state.arquivo_shapefile = None
    except Exception as e:
        st.sidebar.error(f"Erro ao salvar shapefile: {e}")

    # CORRE√á√ÉO: Upload opcional de coordenadas COM PERSIST√äNCIA
    arquivo_coordenadas = st.sidebar.file_uploader(
        "üìç Coordenadas Parcelas (Opcional)",
        type=['csv', 'xlsx', 'xls'],
        help="Arquivo com coordenadas X,Y das parcelas",
        key="upload_coordenadas_persistente"
    )

    # CORRE√á√ÉO: Armazenar coordenadas no session_state de forma segura
    try:
        if arquivo_coordenadas is not None:
            st.session_state.arquivo_coordenadas = arquivo_coordenadas
            st.sidebar.success(f"‚úÖ Coordenadas salvas: {arquivo_coordenadas.name}")
        elif not hasattr(st.session_state, 'arquivo_coordenadas'):
            st.session_state.arquivo_coordenadas = None
    except Exception as e:
        st.sidebar.error(f"Erro ao salvar coordenadas: {e}")

    arquivos = {
        'inventario': arquivo_inventario,
        'cubagem': arquivo_cubagem,
        'shapefile': arquivo_shapefile,
        'coordenadas': arquivo_coordenadas
    }

    # Mostrar status dos arquivos
    mostrar_status_arquivos(arquivos)

    # Mostrar progresso das etapas na sidebar (vers√£o corrigida)
    mostrar_progresso_etapas_sidebar()

    # Mostrar informa√ß√µes adicionais
    mostrar_informacoes_adicionais()

    return arquivos


def mostrar_status_arquivos(arquivos):
    '''
    Mostra o status dos arquivos carregados - VERS√ÉO MELHORADA
    NOVO: Mostra tamb√©m arquivos persistidos no session_state

    Args:
        arquivos: Dict com os arquivos
    '''
    st.sidebar.subheader("üìä Status dos Arquivos")

    # Invent√°rio
    if arquivos['inventario'] is not None:
        st.sidebar.success("‚úÖ Invent√°rio carregado")
        # Mostrar nome do arquivo
        st.sidebar.caption(f"üìÑ {arquivos['inventario'].name}")
    else:
        st.sidebar.error("‚ùå Invent√°rio necess√°rio")

    # Cubagem
    if arquivos['cubagem'] is not None:
        st.sidebar.success("‚úÖ Cubagem carregada")
        # Mostrar nome do arquivo
        st.sidebar.caption(f"üìÑ {arquivos['cubagem'].name}")
    else:
        st.sidebar.error("‚ùå Cubagem necess√°ria")

    # NOVO: Se√ß√£o para arquivos opcionais (verifica session_state tamb√©m)
    st.sidebar.markdown("**Arquivos Opcionais:**")

    # Shapefile - Verificar tanto upload atual quanto session_state
    shapefile_ativo = None
    if arquivos['shapefile'] is not None:
        shapefile_ativo = arquivos['shapefile']
    elif hasattr(st.session_state, 'arquivo_shapefile') and st.session_state.arquivo_shapefile is not None:
        shapefile_ativo = st.session_state.arquivo_shapefile

    if shapefile_ativo is not None:
        st.sidebar.info("üìÅ Shapefile ativo")
        st.sidebar.caption(f"üìÑ {shapefile_ativo.name}")
    else:
        st.sidebar.warning("üìÅ Shapefile: N√£o carregado")

    # Coordenadas - Verificar tanto upload atual quanto session_state
    coordenadas_ativas = None
    if arquivos['coordenadas'] is not None:
        coordenadas_ativas = arquivos['coordenadas']
    elif hasattr(st.session_state, 'arquivo_coordenadas') and st.session_state.arquivo_coordenadas is not None:
        coordenadas_ativas = st.session_state.arquivo_coordenadas

    if coordenadas_ativas is not None:
        st.sidebar.info("üìÅ Coordenadas ativas")
        st.sidebar.caption(f"üìÑ {coordenadas_ativas.name}")
    else:
        st.sidebar.warning("üìÅ Coordenadas: N√£o carregadas")

    # NOVO: Debug opcional para desenvolvedores
    mostrar_debug_arquivos_opcional()


def mostrar_debug_arquivos_opcional():
    '''NOVO: Debug opcional para verificar session_state'''
    if st.sidebar.checkbox("üîç Debug Session State", key="debug_session_arquivos"):
        st.sidebar.markdown("**Session State - Arquivos:**")

        attrs_arquivo = ['arquivo_shapefile', 'arquivo_coordenadas']
        for attr in attrs_arquivo:
            if hasattr(st.session_state, attr):
                value = getattr(st.session_state, attr)
                if value is not None and hasattr(value, 'name'):
                    st.sidebar.success(f"‚úÖ {attr}: {value.name}")
                else:
                    st.sidebar.warning(f"‚ö†Ô∏è {attr}: None")
            else:
                st.sidebar.error(f"‚ùå {attr}: N√£o existe")


def mostrar_progresso_etapas_sidebar():
    '''Mostra o progresso das etapas na sidebar - VERS√ÉO CORRIGIDA'''
    st.sidebar.markdown("---")
    st.sidebar.subheader("üîÑ Progresso das Etapas")

    # CORRE√á√ÉO: Verificar configura√ß√µes primeiro
    config_status = False
    if hasattr(st.session_state, 'config_global'):
        config_status = st.session_state.config_global.get('configurado', False)

    if config_status:
        st.sidebar.success("‚úÖ **Etapa 0** - Configurado")
    else:
        st.sidebar.warning("‚ö†Ô∏è **Etapa 0** - Configure primeiro")

    # CORRE√á√ÉO: Verificar session states de forma segura
    etapas_info = [
        ('resultados_hipsometricos', 'Etapa 1 - Hipsom√©tricos'),
        ('resultados_volumetricos', 'Etapa 2 - Volum√©tricos'),
        ('inventario_processado', 'Etapa 3 - Invent√°rio')
    ]

    etapas_concluidas = 0

    for state_key, nome_etapa in etapas_info:
        # CORRE√á√ÉO: Usar getattr em vez de __dict__
        try:
            resultado = getattr(st.session_state, state_key, None)

            if resultado is not None:
                st.sidebar.success(f"‚úÖ **{nome_etapa}**")

                # Mostrar melhor modelo se dispon√≠vel
                if isinstance(resultado, dict):
                    melhor = resultado.get('melhor_modelo', 'N/A')
                    if melhor != 'N/A':
                        st.sidebar.caption(f"üèÜ Melhor: {melhor}")

                etapas_concluidas += 1
            else:
                st.sidebar.info(f"‚è≥ **{nome_etapa}**")

        except Exception as e:
            # Se houver erro, apenas mostrar como pendente
            st.sidebar.info(f"‚è≥ **{nome_etapa}**")

    # Mostrar progresso geral
    if etapas_concluidas > 0:
        progresso = etapas_concluidas / 3
        st.sidebar.progress(progresso, text=f"Progresso: {etapas_concluidas}/3 etapas")

        if etapas_concluidas == 3:
            st.sidebar.success("üéâ An√°lise Completa!")


def mostrar_informacoes_adicionais():
    '''Mostra informa√ß√µes adicionais na sidebar - VERS√ÉO MELHORADA'''
    st.sidebar.markdown("---")
    st.sidebar.subheader("‚ÑπÔ∏è Informa√ß√µes")

    st.sidebar.markdown('''
    **Formatos aceitos:**
    - CSV (separadores: ; , tab)
    - Excel (.xlsx, .xls, .xlsb)
    - Shapefile (.shp ou .zip)

    **Tamanho m√°ximo:**
    - 200MB por arquivo

    **Encoding:**
    - UTF-8 recomendado
    ''')

    # NOVO: Informa√ß√µes sobre persist√™ncia de arquivos
    with st.sidebar.expander("üíæ Persist√™ncia de Arquivos"):
        st.markdown('''
        **Arquivos Obrigat√≥rios:**
        - Recarregados a cada navega√ß√£o
        - Use sempre os mesmos arquivos

        **Arquivos Opcionais:**
        - ‚úÖ Ficam salvos na sess√£o
        - ‚úÖ Persistem entre p√°ginas
        - ‚úÖ Detectados nas configura√ß√µes

        **Dica:** Carregue shapefile/coordenadas uma vez e navegue livremente!
        ''')

    # NOVO: Mostrar informa√ß√µes sobre configura√ß√µes
    if hasattr(st.session_state, 'config_global'):
        config = st.session_state.config_global
        configurado = config.get('configurado', False)

        st.sidebar.markdown("---")
        st.sidebar.subheader("‚öôÔ∏è Status Configura√ß√£o")

        if configurado:
            st.sidebar.success("‚úÖ Sistema Configurado")

            # Mostrar resumo das configura√ß√µes principais
            with st.sidebar.expander("üìã Resumo Config"):
                st.write(f"‚Ä¢ Di√¢metro min: {config.get('diametro_min', 4.0)} cm")

                talhoes_excluir = config.get('talhoes_excluir', [])
                if talhoes_excluir:
                    st.write(f"‚Ä¢ Talh√µes exclu√≠dos: {len(talhoes_excluir)}")
                else:
                    st.write("‚Ä¢ Talh√µes exclu√≠dos: Nenhum")

                metodo_area = config.get('metodo_area', 'Simular automaticamente')
                st.write(f"‚Ä¢ M√©todo √°rea: {metodo_area[:20]}...")

                # NOVO: Mostrar se arquivos opcionais foram detectados
                if metodo_area == "Coordenadas das parcelas":
                    st.success("üìç Coordenadas detectadas")
                elif metodo_area == "Upload shapefile":
                    st.success("üìÅ Shapefile detectado")
        else:
            st.sidebar.warning("‚ö†Ô∏è Configure o Sistema")
            if st.sidebar.button("‚öôÔ∏è Ir para Configura√ß√µes", use_container_width=True):
                st.switch_page("pages/0_‚öôÔ∏è_Configura√ß√µes.py")

    # NOVO: Bot√µes de a√ß√£o r√°pida melhorados
    mostrar_acoes_rapidas_sidebar()


def mostrar_acoes_rapidas_sidebar():
    '''Se√ß√£o de a√ß√µes r√°pidas na sidebar - VERS√ÉO CORRIGIDA'''
    # CORRE√á√ÉO: Verificar resultados de forma segura
    tem_resultados = False

    try:
        # Verificar cada resultado individualmente
        resultados_disponiveis = [
            getattr(st.session_state, 'resultados_hipsometricos', None),
            getattr(st.session_state, 'resultados_volumetricos', None),
            getattr(st.session_state, 'inventario_processado', None)
        ]

        tem_resultados = any(resultado is not None for resultado in resultados_disponiveis)

    except Exception:
        tem_resultados = False

    if tem_resultados:
        st.sidebar.markdown("---")
        st.sidebar.subheader("‚ö° A√ß√µes R√°pidas")

        col1, col2 = st.sidebar.columns(2)

        with col1:
            if st.button("üîÑ Limpar", use_container_width=True, key="limpar_resultados"):
                # CORRE√á√ÉO: Limpar de forma segura
                keys_para_limpar = ['resultados_hipsometricos', 'resultados_volumetricos', 'inventario_processado']

                for key in keys_para_limpar:
                    if hasattr(st.session_state, key):
                        delattr(st.session_state, key)

                st.sidebar.success("‚úÖ Resultados limpos!")
                st.rerun()

        with col2:
            if st.button("üìä Relat√≥rio", use_container_width=True, key="gerar_relatorio_rapido"):
                st.switch_page("pages/3_üìà_Invent√°rio_Florestal.py")

        # Download r√°pido se invent√°rio foi processado - VERS√ÉO SEGURA
        try:
            inventario_resultado = getattr(st.session_state, 'inventario_processado', None)

            if inventario_resultado is not None and isinstance(inventario_resultado, dict):
                if 'resumo_talhoes' in inventario_resultado:
                    resumo_df = inventario_resultado['resumo_talhoes']
                    csv_dados = resumo_df.to_csv(index=False)

                    st.sidebar.download_button(
                        "üì• Download Resumo",
                        data=csv_dados,
                        file_name="resumo_inventario_rapido.csv",
                        mime="text/csv",
                        use_container_width=True,
                        help="Download r√°pido do resumo por talh√µes"
                    )
        except Exception:
            # Silenciosamente ignorar erro de download se n√£o houver dados
            pass

    # Mostrar dicas contextuais
    mostrar_dicas_contextuais()


def mostrar_dicas_contextuais():
    '''NOVO: Dicas contextuais baseadas no estado atual'''
    st.sidebar.markdown("---")

    # Determinar contexto atual
    dados_carregados = (
            hasattr(st.session_state, 'dados_inventario') and st.session_state.dados_inventario is not None and
            hasattr(st.session_state, 'dados_cubagem') and st.session_state.dados_cubagem is not None
    )

    configurado = (
            hasattr(st.session_state, 'config_global') and
            st.session_state.config_global.get('configurado', False)
    )

    # Dicas baseadas no contexto
    if not dados_carregados:
        st.sidebar.info('''
        **üöÄ Pr√≥ximo Passo:**
        1. Carregue Invent√°rio e Cubagem
        2. Configure o sistema (Etapa 0)
        3. Execute as an√°lises (Etapas 1-3)
        ''')
    elif not configurado:
        st.sidebar.warning('''
        **‚öôÔ∏è Configure o Sistema:**
        Os dados est√£o carregados!
        Agora configure filtros e par√¢metros na Etapa 0.
        ''')
    else:
        st.sidebar.success('''
        **‚úÖ Sistema Pronto:**
        Execute as Etapas 1, 2 e 3 em qualquer ordem.
        As configura√ß√µes se aplicam automaticamente!
        ''')


def mostrar_resumo_sidebar():
    '''Mostra resumo dos resultados na sidebar - VERS√ÉO CORRIGIDA'''
    # CORRE√á√ÉO: Verificar de forma segura
    try:
        inventario_resultado = getattr(st.session_state, 'inventario_processado', None)

        if inventario_resultado is None:
            return

        st.sidebar.markdown("---")
        st.sidebar.subheader("üìä Resumo R√°pido")

        # Verificar se h√° estat√≠sticas gerais
        if isinstance(inventario_resultado, dict) and 'estatisticas_gerais' in inventario_resultado:
            stats = inventario_resultado['estatisticas_gerais']

            # M√©tricas principais na sidebar
            if 'volume_medio_ha' in stats:
                st.sidebar.metric(
                    "üå≤ Produtividade",
                    f"{stats['volume_medio_ha']:.1f} m¬≥/ha"
                )

            if 'area_total' in stats:
                st.sidebar.metric(
                    "üìè √Årea Total",
                    f"{stats['area_total']:.1f} ha"
                )

            if 'estoque_total' in stats:
                st.sidebar.metric(
                    "üå≥ Estoque Total",
                    f"{stats['estoque_total']:,.0f} m¬≥"
                )

            # Classifica√ß√£o r√°pida
            vol_medio = stats.get('volume_medio_ha', 0)
            if vol_medio >= 150:
                st.sidebar.success("üåü Alta Produtividade")
            elif vol_medio >= 100:
                st.sidebar.info("üìä M√©dia Produtividade")
            else:
                st.sidebar.warning("üìà Baixa Produtividade")

    except Exception as e:
        # Em caso de erro, apenas n√£o mostrar o resumo
        pass


def debug_session_state_seguro():
    '''NOVA: Debug seguro do session_state'''
    if st.sidebar.checkbox("üîç Debug Session State", key="debug_session_seguro"):
        st.sidebar.markdown("**Session State - Verifica√ß√£o:**")

        # Verificar atributos importantes
        atributos_importantes = [
            'dados_inventario',
            'dados_cubagem',
            'config_global',
            'resultados_hipsometricos',
            'resultados_volumetricos',
            'inventario_processado',
            'arquivo_shapefile',
            'arquivo_coordenadas'
        ]

        for attr in atributos_importantes:
            try:
                if hasattr(st.session_state, attr):
                    value = getattr(st.session_state, attr)
                    if value is not None:
                        if hasattr(value, 'name'):  # √â um arquivo
                            st.sidebar.success(f"‚úÖ {attr}: {value.name}")
                        elif isinstance(value, dict):
                            st.sidebar.success(f"‚úÖ {attr}: Dict ({len(value)} items)")
                        elif hasattr(value, '__len__'):  # DataFrame ou lista
                            st.sidebar.success(f"‚úÖ {attr}: {type(value).__name__} ({len(value)})")
                        else:
                            st.sidebar.success(f"‚úÖ {attr}: {type(value).__name__}")
                    else:
                        st.sidebar.info(f"‚ÑπÔ∏è {attr}: None")
                else:
                    st.sidebar.warning(f"‚ö†Ô∏è {attr}: N√£o existe")
            except Exception as e:
                st.sidebar.error(f"‚ùå {attr}: Erro ({e})")


def criar_sidebar_melhorada():
    '''
    Vers√£o melhorada da sidebar com todas as funcionalidades
    CORRE√á√ÉO: Todas as fun√ß√µes agora s√£o √† prova de erros

    Returns:
        dict: Dicion√°rio com os arquivos carregados
    '''
    try:
        # Criar sidebar principal com corre√ß√µes
        arquivos = criar_sidebar()

        # Adicionar resumo se an√°lise foi executada (vers√£o segura)
        mostrar_resumo_sidebar()

        # Debug opcional e seguro
        debug_session_state_seguro()

        return arquivos

    except Exception as e:
        st.sidebar.error(f"Erro na sidebar: {e}")
        # Retornar estrutura m√≠nima em caso de erro
        return {
            'inventario': None,
            'cubagem': None,
            'shapefile': None,
            'coordenadas': None
        }


def verificar_e_restaurar_arquivos():
    """
    NOVA: Verifica e restaura status dos arquivos na sidebar
    """
    # Verificar se dados principais ainda existem
    if (hasattr(st.session_state, 'dados_inventario') and st.session_state.dados_inventario is not None and
            hasattr(st.session_state, 'dados_cubagem') and st.session_state.dados_cubagem is not None):
        st.sidebar.success("‚úÖ Dados principais ativos")
        st.sidebar.caption(f"üìä Invent√°rio: {len(st.session_state.dados_inventario)} registros")
        st.sidebar.caption(f"üìè Cubagem: {len(st.session_state.dados_cubagem)} medi√ß√µes")

        # Garantir que arquivos_carregados esteja True
        st.session_state.arquivos_carregados = True

    # Verificar arquivos opcionais
    if hasattr(st.session_state, 'arquivo_shapefile') and st.session_state.arquivo_shapefile is not None:
        st.sidebar.info(f"üìÅ Shapefile persistido: {st.session_state.arquivo_shapefile.name}")

    if hasattr(st.session_state, 'arquivo_coordenadas') and st.session_state.arquivo_coordenadas is not None:
        st.sidebar.info(f"üìç Coordenadas persistidas: {st.session_state.arquivo_coordenadas.name}")


# CORRE√á√ÉO 4: Modificar a fun√ß√£o criar_sidebar() para incluir verifica√ß√£o

def criar_sidebar_com_verificacao():
    """
    Cria sidebar com verifica√ß√£o de arquivos persistidos
    """
    st.sidebar.header("üìÅ Upload de Dados")

    # NOVO: Verificar e mostrar arquivos persistidos primeiro
    verificar_e_restaurar_arquivos()

    # Upload do arquivo de invent√°rio
    arquivo_inventario = st.sidebar.file_uploader(
        "üìã Arquivo de Invent√°rio",
        type=['csv', 'xlsx', 'xls'],
        help="Dados de parcelas (D_cm, H_m, talhao, parcela, cod, idade_anos)"
    )

    # Upload do arquivo de cubagem
    arquivo_cubagem = st.sidebar.file_uploader(
        "üìè Arquivo de Cubagem",
        type=['csv', 'xlsx', 'xls'],
        help="Medi√ß√µes detalhadas (arv, talhao, d_cm, h_m, D_cm, H_m)"
    )

    # Upload opcional de shapefile para √°reas COM PERSIST√äNCIA
    arquivo_shapefile = st.sidebar.file_uploader(
        "üó∫Ô∏è Shapefile √Åreas (Opcional)",
        type=['shp', 'zip'],
        help="Arquivo shapefile com √°reas dos talh√µes",
        key="upload_shapefile_persistente"
    )

    # Armazenar shapefile no session_state de forma segura
    try:
        if arquivo_shapefile is not None:
            st.session_state.arquivo_shapefile = arquivo_shapefile
            st.sidebar.success(f"‚úÖ Shapefile salvo: {arquivo_shapefile.name}")
        elif not hasattr(st.session_state, 'arquivo_shapefile'):
            st.session_state.arquivo_shapefile = None
    except Exception as e:
        st.sidebar.error(f"Erro ao salvar shapefile: {e}")

    # Upload opcional de coordenadas COM PERSIST√äNCIA
    arquivo_coordenadas = st.sidebar.file_uploader(
        "üìç Coordenadas Parcelas (Opcional)",
        type=['csv', 'xlsx', 'xls'],
        help="Arquivo com coordenadas X,Y das parcelas",
        key="upload_coordenadas_persistente"
    )

    # Armazenar coordenadas no session_state de forma segura
    try:
        if arquivo_coordenadas is not None:
            st.session_state.arquivo_coordenadas = arquivo_coordenadas
            st.sidebar.success(f"‚úÖ Coordenadas salvas: {arquivo_coordenadas.name}")
        elif not hasattr(st.session_state, 'arquivo_coordenadas'):
            st.session_state.arquivo_coordenadas = None
    except Exception as e:
        st.sidebar.error(f"Erro ao salvar coordenadas: {e}")

    arquivos = {
        'inventario': arquivo_inventario,
        'cubagem': arquivo_cubagem,
        'shapefile': arquivo_shapefile,
        'coordenadas': arquivo_coordenadas
    }

    # Mostrar status dos arquivos
    mostrar_status_arquivos_melhorado(arquivos)

    # Mostrar progresso das etapas na sidebar
    mostrar_progresso_etapas_sidebar()

    # Mostrar informa√ß√µes adicionais
    mostrar_informacoes_adicionais()

    return arquivos


def mostrar_status_arquivos_melhorado(arquivos):
    """
    Mostra status melhorado dos arquivos
    """
    st.sidebar.subheader("üìä Status dos Arquivos")

    # Verificar dados principais (considerar tanto upload quanto session_state)
    inventario_ativo = (
            arquivos['inventario'] is not None or
            (hasattr(st.session_state, 'dados_inventario') and st.session_state.dados_inventario is not None)
    )

    cubagem_ativa = (
            arquivos['cubagem'] is not None or
            (hasattr(st.session_state, 'dados_cubagem') and st.session_state.dados_cubagem is not None)
    )

    # Status invent√°rio
    if inventario_ativo:
        if arquivos['inventario'] is not None:
            st.sidebar.success("‚úÖ Invent√°rio carregado (novo)")
            st.sidebar.caption(f"üìÑ {arquivos['inventario'].name}")
        else:
            st.sidebar.success("‚úÖ Invent√°rio ativo (sess√£o)")
    else:
        st.sidebar.error("‚ùå Invent√°rio necess√°rio")

    # Status cubagem
    if cubagem_ativa:
        if arquivos['cubagem'] is not None:
            st.sidebar.success("‚úÖ Cubagem carregada (nova)")
            st.sidebar.caption(f"üìÑ {arquivos['cubagem'].name}")
        else:
            st.sidebar.success("‚úÖ Cubagem ativa (sess√£o)")
    else:
        st.sidebar.error("‚ùå Cubagem necess√°ria")

    # Arquivos opcionais
    st.sidebar.markdown("**Arquivos Opcionais:**")

    # Shapefile
    shapefile_ativo = (
            arquivos['shapefile'] is not None or
            (hasattr(st.session_state, 'arquivo_shapefile') and st.session_state.arquivo_shapefile is not None)
    )

    if shapefile_ativo:
        if arquivos['shapefile'] is not None:
            st.sidebar.info("üìÅ Shapefile (novo)")
            st.sidebar.caption(f"üìÑ {arquivos['shapefile'].name}")
        else:
            st.sidebar.info("üìÅ Shapefile (persistido)")
            st.sidebar.caption(f"üìÑ {st.session_state.arquivo_shapefile.name}")
    else:
        st.sidebar.warning("üìÅ Shapefile: N√£o carregado")

    # Coordenadas
    coordenadas_ativas = (
            arquivos['coordenadas'] is not None or
            (hasattr(st.session_state, 'arquivo_coordenadas') and st.session_state.arquivo_coordenadas is not None)
    )

    if coordenadas_ativas:
        if arquivos['coordenadas'] is not None:
            st.sidebar.info("üìç Coordenadas (novas)")
            st.sidebar.caption(f"üìÑ {arquivos['coordenadas'].name}")
        else:
            st.sidebar.info("üìç Coordenadas (persistidas)")
            st.sidebar.caption(f"üìÑ {st.session_state.arquivo_coordenadas.name}")
    else:
        st.sidebar.warning("üìç Coordenadas: N√£o carregadas")


# FUN√á√ÉO AUXILIAR PARA VERIFICAR ARQUIVOS PERSISTIDOS
def obter_arquivos_com_persistencia():
    '''
    NOVA: Obt√©m arquivos considerando tanto upload atual quanto session_state

    Returns:
        dict: Arquivos dispon√≠veis (atuais + persistidos)
    '''
    arquivos_persistidos = {}

    # Shapefile
    if hasattr(st.session_state, 'arquivo_shapefile') and st.session_state.arquivo_shapefile is not None:
        arquivos_persistidos['shapefile'] = st.session_state.arquivo_shapefile

    # Coordenadas
    if hasattr(st.session_state, 'arquivo_coordenadas') and st.session_state.arquivo_coordenadas is not None:
        arquivos_persistidos['coordenadas'] = st.session_state.arquivo_coordenadas

    return arquivos_persistidos


# FUN√á√ÉO PARA LIMPAR ARQUIVOS PERSISTIDOS
def limpar_arquivos_persistidos():
    '''NOVA: Limpa arquivos opcionais do session_state'''
    if hasattr(st.session_state, 'arquivo_shapefile'):
        st.session_state.arquivo_shapefile = None

    if hasattr(st.session_state, 'arquivo_coordenadas'):
        st.session_state.arquivo_coordenadas = None

    st.sidebar.success("üóëÔ∏è Arquivos opcionais removidos!")